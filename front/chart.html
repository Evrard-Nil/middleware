<!doctype html>
<html>

<head>
	<meta charset="utf-8">
	<script src="node_modules/chart.js/dist/Chart.min.js"></script>
	<script src="node_modules/chart.js/dist/Chart.js"></script>
	<script src="utils.js"></script>
	<style>
		/* Create two equal columns that floats next to each other */
		.column {
			padding: 10px;
			height: 300px; /* Should be removed. Only for demonstration */
		}

		#airport-title {
			color: #444;
			font-weight: 300;
			font-size: 1.5rem;
		}

		.row {
			-webkit-align-content: center;
			align-content: center;
			position: relative;
			height: 50%;
			width: 100%;
		}

		/* Clear floats after the columns */
		.row:after {
			content: "";
			display: table;
			clear: both;
		}

		.card {
			/* Add shadows to create the "card" effect */
			box-shadow: 0 4px 16px 0 rgba(0,0,0,0.2);
			transition: 0.3s;
		}

		/* On mouse-over, add a deeper shadow */
		.card:hover {
			box-shadow: 0 8px 32px 0 rgba(0,0,0,0.2);
		}

		/* Add some padding inside the card container */
		.container {
			padding: 2px 16px;
			margin: 10 10 10 10;
		}

		canvas{
			-moz-user-select: none;
			-webkit-user-select: none;
			-ms-user-select: none;
		}
	</style>
</head>

<body>
	<div id="airport-title"></div>
	<div class="row">
		<div class="column" style="width: 75%; float: left;">
			<canvas id="temp-mesures"></canvas>
			<canvas id="pres-mesures"></canvas>
			<canvas id="wind-mesures"></canvas>
		</div>
		<div class="column" style="width: 20%; float: right;">
			<div class="card">
				<div class="container">
					<h4><b>Temperature average</b></h4> 
					<p id="averageTemp"></p> 
				</div>
				<div class="container">
					<h4><b>Pressure average</b></h4> 
					<p id="averagePres"></p> 
				</div>
				<div class="container">
					<h4><b>Wind average</b></h4> 
					<p id="averageWind"></p> 
				</div>
			</div>
		</div>
	</div>
	

	<script>
		const baseUrl = 'http://localhost:8082/api/v1/'
		var airportId;
		var airportName;

		// Get the page informations like the airport ID and name
		function getInformations() {
			var parameters = location.search.substring(1).split("&")
			var temp = parameters[0].split("=")
			airportId = unescape(temp[1])
			temp = parameters[1].split("=")
			airportName = unescape(temp[1])
			document.title = airportName + " airport charts"
			document.getElementById("airport-title").innerHTML = airportName + " airport"
		}

		// Get the measures for a type of graphic 
		function getMeasures(chart, typ, _callback) {
			let xhttp = new XMLHttpRequest()
			var url = baseUrl + "measures/" + airportId + "/" + typ + "?beginDate=2010-10-10T12:12:12Z&endDate=2040-10-10T12:12:12Z"

			xhttp.onreadystatechange = function () {
				if (xhttp.readyState === 4) {
					var data = JSON.parse(this.responseText)
					console.log("xhttp")
					console.log(data)
					
					_callback(chart, data)
				}
			};

			xhttp.open("GET", url, true)
			xhttp.send()
		}

		// Get the average measures for an airport
		function getAverages() {
			let xhttp = new XMLHttpRequest()
			var url = baseUrl + "averages/" + airportId + "?date=2020-10-10"

			xhttp.onreadystatechange = function () {
				if (xhttp.readyState === 4) {
					var data = JSON.parse(this.responseText);
					// we get the returned data
					document.getElementById("averageTemp").innerHTML = data["averageTemp"]
					document.getElementById("averagePres").innerHTML = data["averagePres"]
					document.getElementById("averageWind").innerHTML = data["averageWind"]
				}
				// end of state change: it can be after some time (async)
			};

			xhttp.open("GET", url, true, )
			xhttp.send()
		}

		// Creates the temperature chart
		function createChart(chart, data) {
			console.log("create")
			console.log(data)

			let chartData;
			let chartDatas = [];
			for(let i = 0; i < Object.keys("measures").length; i++) {
				chartData = {
					x: new Date(data["measures"][i].date),
					y: data["measures"][i].value
				}
				chartDatas.push(chartData)
			}

			addData(chart, '', chartDatas)
		}

		// Add data to a chart
		function addData(chart, label, data) {
			chart.data.labels.push(label);
			chart.data.datasets.forEach((dataset) => {
				dataset.data.push(data);
			});
			console.log("hello")
			chart.update();
		}

		var tempConfig = {
			type: 'line',
			data: {
				labels: ['January', 'February', 'March', 'April', 'May', 'June', 'July'],
				datasets: [{
					label: 'Temperature data',
					backgroundColor: window.chartColors.yellow,
					borderColor: window.chartColors.yellow,
					data: [
						[10, 20, 30, 10, 120, 43, 12]
					],
					fill: false,
				}]
			},
			options: {
				responsive: true,
				title: {
					display: true,
					text: 'Temperature Chart'
				},
				tooltips: {
					mode: 'index',
					intersect: false,
				},
				hover: {
					mode: 'nearest',
					intersect: true
				},
				scales: {
					xAxes: [{
						display: true,
						scaleLabel: {
							display: true,
							labelString: 'Month'
						},
					}],
					yAxes: [{
						display: true,
						scaleLabel: {
							display: true,
							labelString: 'Temperature (°C)'
						},
					}]
				}
			}
		};

		var presConfig = {
			type: 'line',
			data: {
				labels: ['January', 'February', 'March', 'April', 'May', 'June', 'July'],
				datasets: [{
					label: 'Pressure data',
					backgroundColor: window.chartColors.blue,
					borderColor: window.chartColors.blue,
					data: [
						[10, 20, 30, 10, 50, 65, 12]
					],
					fill: false,
				}]
			},
			options: {
				responsive: true,
				title: {
					display: true,
					text: 'Pressure Chart'
				},
				tooltips: {
					mode: 'index',
					intersect: false,
				},
				hover: {
					mode: 'nearest',
					intersect: true
				},
				scales: {
					xAxes: [{
						display: true,
						scaleLabel: {
							display: true,
							labelString: 'Month'
						}
					}],
					yAxes: [{
						display: true,
						scaleLabel: {
							display: true,
							labelString: 'Pressure (Pa)'
						}
					}]
				}
			}
		};

		var windConfig = {
			type: 'line',
			data: {
				labels: ['January', 'February', 'March', 'April', 'May', 'June', 'July'],
				datasets: [{
					label: 'Wind data',
					backgroundColor: window.chartColors.green,
					borderColor: window.chartColors.green,
					data: [
						[10, 20, 30, 10, 50, 65, 12]
					],
					fill: false,
				}]
			},
			options: {
				responsive: true,
				title: {
					display: true,
					text: 'Wind Chart'
				},
				tooltips: {
					mode: 'index',
					intersect: false,
				},
				hover: {
					mode: 'nearest',
					intersect: true
				},
				scales: {
					xAxes: [{
						display: true,
						scaleLabel: {
							display: true,
							labelString: 'Month'
						}
					}],
					yAxes: [{
						display: true,
						scaleLabel: {
							display: true,
							labelString: 'Wind (°C)'
						}
					}]
				}
			}
		};
		window.onload = function() {
			getInformations()
			/* getMeasures("atmospheric_pressure")
			getMeasures("wind_speed")
			getAverages() */

			var ctx = document.getElementById('temp-mesures').getContext('2d');
			var tempChart = new Chart(ctx, tempConfig);
			var ctx = document.getElementById('pres-mesures').getContext('2d');
			var presChart = new Chart(ctx, presConfig);
			var ctx = document.getElementById('wind-mesures').getContext('2d');
			var windChart = new Chart(ctx, windConfig);

			getMeasures(tempChart, "temperature", createChart)
		};
		var colorNames = Object.keys(window.chartColors);
	</script>
</body>

</html>